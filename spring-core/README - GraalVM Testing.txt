==========================================================================================
=== INSTRUCTIONS
==========================================================================================

1. Download the Java 8 version of GraalVM.

   We are currently using the following version.

   https://github.com/graalvm/graalvm-ce-builds/releases/tag/vm-20.0.0

------------------------------------------------------------------------------------------

2. Unpack the archive and set the JAVA_HOME environment variable to point to it. Then
   modify the PATH environment variable to include JAVA_HOME/bin. Then run `gu install
   native-image` to download the native-image command.

   For example, if you are developing on Mac OS and you unpacked the archive into
   /opt/graalvm/graalvm-ce-java8-20.0.0, the following commands should work.

   export GRAALVM_HOME=/opt/graalvm/graalvm-ce-java8-20.0.0/Contents/Home
   export PATH=$GRAALVM_HOME/bin:$PATH
   export JAVA_HOME=$GRAALVM_HOME
   
   Executing `java -version` should then display something similar to the following.

     openjdk version "1.8.0_242"
     OpenJDK Runtime Environment (build 1.8.0_242-b06)
     OpenJDK 64-Bit Server VM GraalVM CE 20.0.0 (build 25.242-b06-jvmci-20.0-b02, mixed mode)

------------------------------------------------------------------------------------------

3. Execute `../gradlew createTestClasspathFile` within the spring-core directory to create
   a file named `test_classpath.txt` in the `build` directory that contains classpath entries
   for dependencies of spring-core. This file will be used by shell scripts discussed later.

------------------------------------------------------------------------------------------

4. Execute `. ./setcp.sh` to set the CP environment variable that contains the classpath
   entries used by later scripts. Note that the initial "." is necessary in order to have
   the script evaluated in the current shell.

------------------------------------------------------------------------------------------

5. Run the tests using the standard Gradle test task with `-DnativeImageTesting=true` in
   order to have test classes that use unsupported features filtered from the list of
   test classes.

   ../gradlew -DnativeImageTesting=true test

   Open `build/reports/tests/test/index.html` to see the test results.

   Open `build/test_classes.txt` to see the list of test classes that will be executed
   within the native image. Note that TestClassTrackingTestExecutionListener is an
   automatically registered JUnit Platform TestExecutionListener that creates this file.

------------------------------------------------------------------------------------------

6. `getActiveTests.sh` is used to convert `build/test_classes.txt` into a single string
   that can be passed to JUnit's ConsoleLauncher as command line arguments. This script
   will be used by later scripts to execute the filtered list of test classes.

------------------------------------------------------------------------------------------

7. Execute `runTestsWithAgent.sh` to run the tests with the GraalVM JVM agent.

------------------------------------------------------------------------------------------

8. Execute the `ni.sh` script which compiles a `spring-core-tests.bin` native image
   executable in the `build` directory using the configuration generated by the GraalVM
   JVM agent in the `build/graalvm` directory combined with the hand-crafted configuration
   found in `src/test/resources/META-INF/native-image`.

------------------------------------------------------------------------------------------

9. Execute `runTestsInNativeImage.sh` to run the tests in the native image.

------------------------------------------------------------------------------------------




==========================================================================================
=== NOTES
==========================================================================================

AnnotatedElementUtilsTests:

- javaxAnnotationTypeViaFindMergedAnnotation() requires the following in proxy-config:
    ["javax.annotation.Resource", "org.springframework.core.annotation.SynthesizedAnnotation"]

------------------------------------------------------------------------------------------

DefaultConversionServiceTests:

- convertObjectToStringWithJavaTimeOfMethodPresent(): fails because the GraalVM agent does
	not detect that it needs to include superclasses in reflect-config.json when
	Class#getMethod is invoked (as in org.springframework.util.ClassUtils.getStaticMethod()).
	This may be a bug in the GraalVM agent. As a workaround, we have added an
	`allDeclaredMethods` entry to reflect-config.json for java.time.ZoneRegion so that the
	`of(String)` method defined in ZoneId (ZoneRegion's superclass) is visible via reflection.

- convertStringToTimezone(): fails because it uses java.util.TimeZone.getTimeZone(String)
	with a custom Zone ID which doesn't seem to be properly supported in a GraalVM native
	image (perhaps due to the use of sun.util.calendar.ZoneInfoFile.getCustomTimeZone()).
	Assertion failure: Expecting: <"GMT"> to be equal to: <"GMT+02:00"> but was not.
	We have circumvented this by aborting this test method when running in a native image.

------------------------------------------------------------------------------------------

Reflection:

- Member classes are not automatically registered for reflective access within a native
	image by the JVM agent. To enable this support, one must manually set `allPublicClasses`
	and `allDeclaredClasses` to `true` in `reflect-config.json`.
	
	From the GraalVM wiki:

	"However, allPublicClasses and allDeclaredClasses don't automatically register the
	inner classes for reflective access. They just make them available via Class.getClasses()
	and Class.getDeclaredClasses() when called on the declaring class."

	https://github.com/oracle/graal/blob/master/substratevm/REFLECTION.md#manual-configuration

    Entries have been manually added to `reflect-config.json` for the following:
	  - org.springframework.core.type.StandardAnnotationMetadataTests
      - org.springframework.core.type.StandardClassMetadataMemberClassTests

------------------------------------------------------------------------------------------


